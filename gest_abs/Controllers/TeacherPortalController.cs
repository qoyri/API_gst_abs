using Microsoft.AspNetCore.Mvc;
using Microsoft.AspNetCore.Authorization;
using Microsoft.EntityFrameworkCore;
using gest_abs.Services;
using gest_abs.DTO;
using gest_abs.Models;
using System.Security.Claims;

namespace gest_abs.Controllers
{
    [Route("api/teacher-portal")]
    [ApiController]
    [Authorize(Roles = "professeur")] // ðŸ”¹ Seuls les professeurs peuvent accÃ©der Ã  ces endpoints
    public class TeacherPortalController : ControllerBase
    {
        private readonly TeacherService _teacherService;
        private readonly GestionAbsencesContext _context;

        public TeacherPortalController(TeacherService teacherService, GestionAbsencesContext context)
        {
            _teacherService = teacherService;
            _context = context;
        }

        // ðŸ”¹ GET /api/teacher-portal/dashboard â†’ RÃ©cupÃ©rer le tableau de bord du professeur
        [HttpGet("dashboard")]
        public async Task<IActionResult> GetDashboard()
        {
            try
            {
                var teacherEmail = User.FindFirst(ClaimTypes.Name)?.Value;
                if (string.IsNullOrEmpty(teacherEmail))
                {
                    return Unauthorized(new ErrorResponseDTO { Message = "Utilisateur non authentifiÃ©." });
                }

                var dashboard = await _teacherService.GetTeacherDashboard(teacherEmail);
                if (dashboard == null)
                {
                    return NotFound(new ErrorResponseDTO { Message = "Tableau de bord non trouvÃ©." });
                }

                return Ok(dashboard);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new ErrorResponseDTO { Message = $"Erreur interne du serveur: {ex.Message}" });
            }
        }

        // ðŸ”¹ GET /api/teacher-portal/profile â†’ RÃ©cupÃ©rer le profil du professeur
        [HttpGet("profile")]
        public async Task<IActionResult> GetProfile()
        {
            try
            {
                var teacherEmail = User.FindFirst(ClaimTypes.Name)?.Value;
                if (string.IsNullOrEmpty(teacherEmail))
                {
                    return Unauthorized(new ErrorResponseDTO { Message = "Utilisateur non authentifiÃ©." });
                }

                var profile = await _teacherService.GetTeacherProfile(teacherEmail);
                if (profile == null)
                {
                    return NotFound(new ErrorResponseDTO { Message = "Profil non trouvÃ©." });
                }

                return Ok(profile);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new ErrorResponseDTO { Message = $"Erreur interne du serveur: {ex.Message}" });
            }
        }

        // ðŸ”¹ PUT /api/teacher-portal/profile â†’ Mettre Ã  jour le profil du professeur
        [HttpPut("profile")]
        public async Task<IActionResult> UpdateProfile([FromBody] TeacherUpdateProfileDTO updateDTO)
        {
            try
            {
                var teacherEmail = User.FindFirst(ClaimTypes.Name)?.Value;
                if (string.IsNullOrEmpty(teacherEmail))
                {
                    return Unauthorized(new ErrorResponseDTO { Message = "Utilisateur non authentifiÃ©." });
                }

                var success = await _teacherService.UpdateTeacherProfile(teacherEmail, updateDTO);
                if (!success)
                {
                    return BadRequest(new ErrorResponseDTO { Message = "Mise Ã  jour du profil impossible." });
                }

                return Ok(new { Message = "Profil mis Ã  jour avec succÃ¨s." });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new ErrorResponseDTO { Message = $"Erreur interne du serveur: {ex.Message}" });
            }
        }

        // ðŸ”¹ GET /api/teacher-portal/classes â†’ RÃ©cupÃ©rer les classes du professeur
        [HttpGet("classes")]
        public async Task<IActionResult> GetClasses()
        {
            try
            {
                var teacherEmail = User.FindFirst(ClaimTypes.Name)?.Value;
                if (string.IsNullOrEmpty(teacherEmail))
                {
                    return Unauthorized(new ErrorResponseDTO { Message = "Utilisateur non authentifiÃ©." });
                }

                var classes = await _teacherService.GetTeacherClasses(teacherEmail);
                return Ok(classes);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new ErrorResponseDTO { Message = $"Erreur interne du serveur: {ex.Message}" });
            }
        }

        // ðŸ”¹ GET /api/teacher-portal/classes/{id} â†’ RÃ©cupÃ©rer les dÃ©tails d'une classe
        [HttpGet("classes/{id}")]
        public async Task<IActionResult> GetClassDetails(int id)
        {
            try
            {
                var teacherEmail = User.FindFirst(ClaimTypes.Name)?.Value;
                if (string.IsNullOrEmpty(teacherEmail))
                {
                    return Unauthorized(new ErrorResponseDTO { Message = "Utilisateur non authentifiÃ©." });
                }

                var classDetails = await _teacherService.GetClassDetails(teacherEmail, id);
                if (classDetails == null)
                {
                    return NotFound(new ErrorResponseDTO { Message = "Classe non trouvÃ©e ou non autorisÃ©e." });
                }

                return Ok(classDetails);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new ErrorResponseDTO { Message = $"Erreur interne du serveur: {ex.Message}" });
            }
        }

        // ðŸ”¹ GET /api/teacher-portal/notifications â†’ RÃ©cupÃ©rer les notifications du professeur
        [HttpGet("notifications")]
        public async Task<IActionResult> GetNotifications()
        {
            try
            {
                var teacherEmail = User.FindFirst(ClaimTypes.Name)?.Value;
                if (string.IsNullOrEmpty(teacherEmail))
                {
                    return Unauthorized(new ErrorResponseDTO { Message = "Utilisateur non authentifiÃ©." });
                }

                var notifications = await _teacherService.GetTeacherNotifications(teacherEmail);
                return Ok(notifications);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new ErrorResponseDTO { Message = $"Erreur interne du serveur: {ex.Message}" });
            }
        }

        // ðŸ”¹ PUT /api/teacher-portal/notifications/{id}/read â†’ Marquer une notification comme lue
        [HttpPut("notifications/{id}/read")]
        public async Task<IActionResult> MarkNotificationAsRead(int id)
        {
            try
            {
                var teacherEmail = User.FindFirst(ClaimTypes.Name)?.Value;
                if (string.IsNullOrEmpty(teacherEmail))
                {
                    return Unauthorized(new ErrorResponseDTO { Message = "Utilisateur non authentifiÃ©." });
                }

                var success = await _teacherService.MarkNotificationAsRead(teacherEmail, id);
                if (!success)
                {
                    return NotFound(new ErrorResponseDTO { Message = "Notification non trouvÃ©e ou non autorisÃ©e." });
                }

                return Ok(new { Message = "Notification marquÃ©e comme lue." });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new ErrorResponseDTO { Message = $"Erreur interne du serveur: {ex.Message}" });
            }
        }

        // ðŸ”¹ GET /api/teacher-portal/reservations â†’ RÃ©cupÃ©rer les rÃ©servations du professeur
        [HttpGet("reservations")]
        public async Task<IActionResult> GetReservations([FromQuery] DateTime? startDate, [FromQuery] DateTime? endDate)
        {
            try
            {
                var teacherEmail = User.FindFirst(ClaimTypes.Name)?.Value;
                if (string.IsNullOrEmpty(teacherEmail))
                {
                    return Unauthorized(new ErrorResponseDTO { Message = "Utilisateur non authentifiÃ©." });
                }

                var reservations = await _teacherService.GetTeacherReservations(teacherEmail, startDate, endDate);
                return Ok(reservations);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new ErrorResponseDTO { Message = $"Erreur interne du serveur: {ex.Message}" });
            }
        }

        // ðŸ”¹ POST /api/teacher-portal/reservations â†’ CrÃ©er une rÃ©servation
        [HttpPost("reservations")]
        public async Task<IActionResult> CreateReservation([FromBody] ReservationCreateDTO createDTO)
        {
            try
            {
                var teacherEmail = User.FindFirst(ClaimTypes.Name)?.Value;
                if (string.IsNullOrEmpty(teacherEmail))
                {
                    return Unauthorized(new ErrorResponseDTO { Message = "Utilisateur non authentifiÃ©." });
                }

                var reservation = await _teacherService.CreateReservation(teacherEmail, createDTO);
                if (reservation == null)
                {
                    return BadRequest(new ErrorResponseDTO { Message = "CrÃ©ation de rÃ©servation impossible." });
                }

                return CreatedAtAction(nameof(GetReservationById), new { id = reservation.Id }, reservation);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new ErrorResponseDTO { Message = $"Erreur interne du serveur: {ex.Message}" });
            }
        }

        // ðŸ”¹ GET /api/teacher-portal/reservations/{id} â†’ RÃ©cupÃ©rer une rÃ©servation
        [HttpGet("reservations/{id}")]
        public async Task<IActionResult> GetReservationById(int id)
        {
            try
            {
                var teacherEmail = User.FindFirst(ClaimTypes.Name)?.Value;
                if (string.IsNullOrEmpty(teacherEmail))
                {
                    return Unauthorized(new ErrorResponseDTO { Message = "Utilisateur non authentifiÃ©." });
                }

                var userId = await _context.Users
                    .Where(u => u.Email == teacherEmail)
                    .Select(u => u.Id)
                    .FirstOrDefaultAsync();

                var reservation = await _context.Reservations
                    .Include(r => r.Room)
                    .FirstOrDefaultAsync(r => r.Id == id && r.UserId == userId);

                if (reservation == null)
                {
                    return NotFound(new ErrorResponseDTO { Message = "RÃ©servation non trouvÃ©e ou non autorisÃ©e." });
                }

                var reservationDTO = new ReservationDTO
                {
                    Id = reservation.Id,
                    RoomId = reservation.RoomId,
                    RoomName = reservation.Room.Name,
                    ReservationDate = reservation.ReservationDate,
                    StartTime = reservation.StartTime,
                    EndTime = reservation.EndTime
                };

                return Ok(reservationDTO);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new ErrorResponseDTO { Message = $"Erreur interne du serveur: {ex.Message}" });
            }
        }

        // ðŸ”¹ PUT /api/teacher-portal/reservations/{id} â†’ Mettre Ã  jour une rÃ©servation
        [HttpPut("reservations/{id}")]
        public async Task<IActionResult> UpdateReservation(int id, [FromBody] ReservationUpdateDTO updateDTO)
        {
            try
            {
                var teacherEmail = User.FindFirst(ClaimTypes.Name)?.Value;
                if (string.IsNullOrEmpty(teacherEmail))
                {
                    return Unauthorized(new ErrorResponseDTO { Message = "Utilisateur non authentifiÃ©." });
                }

                var success = await _teacherService.UpdateReservation(teacherEmail, id, updateDTO);
                if (!success)
                {
                    return BadRequest(new ErrorResponseDTO { Message = "Mise Ã  jour de rÃ©servation impossible." });
                }

                return Ok(new { Message = "RÃ©servation mise Ã  jour avec succÃ¨s." });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new ErrorResponseDTO { Message = $"Erreur interne du serveur: {ex.Message}" });
            }
        }

        // ðŸ”¹ DELETE /api/teacher-portal/reservations/{id} â†’ Supprimer une rÃ©servation
        [HttpDelete("reservations/{id}")]
        public async Task<IActionResult> DeleteReservation(int id)
        {
            try
            {
                var teacherEmail = User.FindFirst(ClaimTypes.Name)?.Value;
                if (string.IsNullOrEmpty(teacherEmail))
                {
                    return Unauthorized(new ErrorResponseDTO { Message = "Utilisateur non authentifiÃ©." });
                }

                var success = await _teacherService.DeleteReservation(teacherEmail, id);
                if (!success)
                {
                    return NotFound(new ErrorResponseDTO { Message = "RÃ©servation non trouvÃ©e ou non autorisÃ©e." });
                }

                return Ok(new { Message = "RÃ©servation supprimÃ©e avec succÃ¨s." });
            }
            catch (Exception ex)
            {
                return StatusCode(500, new ErrorResponseDTO { Message = $"Erreur interne du serveur: {ex.Message}" });
            }
        }

        // ðŸ”¹ POST /api/teacher-portal/absences â†’ CrÃ©er une absence
        [HttpPost("absences")]
        public async Task<IActionResult> CreateAbsence([FromBody] AbsenceCreateDTO createDTO)
        {
            try
            {
                var teacherEmail = User.FindFirst(ClaimTypes.Name)?.Value;
                if (string.IsNullOrEmpty(teacherEmail))
                {
                    return Unauthorized(new ErrorResponseDTO { Message = "Utilisateur non authentifiÃ©." });
                }

                var absence = await _teacherService.CreateAbsence(teacherEmail, createDTO);
                if (absence == null)
                {
                    return BadRequest(new ErrorResponseDTO { Message = "CrÃ©ation d'absence impossible." });
                }

                return CreatedAtAction("GetAbsenceById", "TeacherController", new { id = absence.Id }, absence);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new ErrorResponseDTO { Message = $"Erreur interne du serveur: {ex.Message}" });
            }
        }

        // ðŸ”¹ GET /api/teacher-portal/stats/class/{classId} â†’ RÃ©cupÃ©rer les statistiques d'une classe
        [HttpGet("stats/class/{classId}")]
        public async Task<IActionResult> GetClassStats(int classId)
        {
            try
            {
                var teacherEmail = User.FindFirst(ClaimTypes.Name)?.Value;
                if (string.IsNullOrEmpty(teacherEmail))
                {
                    return Unauthorized(new ErrorResponseDTO { Message = "Utilisateur non authentifiÃ©." });
                }

                var teacherId = await _context.Teachers
                    .Where(t => t.User.Email == teacherEmail)
                    .Select(t => t.Id)
                    .FirstOrDefaultAsync();

                // VÃ©rifier que l'enseignant a accÃ¨s Ã  cette classe
                var hasAccess = await _context.Classes
                    .AnyAsync(c => c.Id == classId && c.TeacherId == teacherId);

                if (!hasAccess)
                    return Forbid();

                var stats = await _teacherService.GetClassStatistics(classId);
                if (stats == null)
                {
                    return NotFound(new ErrorResponseDTO { Message = "Statistiques non trouvÃ©es." });
                }

                return Ok(stats);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new ErrorResponseDTO { Message = $"Erreur interne du serveur: {ex.Message}" });
            }
        }

        // ðŸ”¹ GET /api/teacher-portal/stats/student/{studentId} â†’ RÃ©cupÃ©rer les statistiques d'un Ã©tudiant
        [HttpGet("stats/student/{studentId}")]
        public async Task<IActionResult> GetStudentStats(int studentId)
        {
            try
            {
                var teacherEmail = User.FindFirst(ClaimTypes.Name)?.Value;
                if (string.IsNullOrEmpty(teacherEmail))
                {
                    return Unauthorized(new ErrorResponseDTO { Message = "Utilisateur non authentifiÃ©." });
                }

                var teacherId = await _context.Teachers
                    .Where(t => t.User.Email == teacherEmail)
                    .Select(t => t.Id)
                    .FirstOrDefaultAsync();

                // VÃ©rifier que l'Ã©tudiant appartient Ã  une classe de l'enseignant
                var student = await _context.Students
                    .Include(s => s.Class)
                    .FirstOrDefaultAsync(s => s.Id == studentId && s.Class.TeacherId == teacherId);

                if (student == null)
                    return NotFound(new ErrorResponseDTO { Message = "Ã‰tudiant non trouvÃ© ou non autorisÃ©." });

                var stats = await _teacherService.GetStudentStatistics(studentId);
                if (stats == null)
                {
                    return NotFound(new ErrorResponseDTO { Message = "Statistiques non trouvÃ©es." });
                }

                return Ok(stats);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new ErrorResponseDTO { Message = $"Erreur interne du serveur: {ex.Message}" });
            }
        }

        // ðŸ”¹ GET /api/teacher-portal/reports/absences â†’ GÃ©nÃ©rer un rapport d'absences
        [HttpGet("reports/absences")]
        public async Task<IActionResult> GetAbsenceReport([FromQuery] ReportFilterDTO filter)
        {
            try
            {
                var teacherEmail = User.FindFirst(ClaimTypes.Name)?.Value;
                if (string.IsNullOrEmpty(teacherEmail))
                {
                    return Unauthorized(new ErrorResponseDTO { Message = "Utilisateur non authentifiÃ©." });
                }

                var teacherId = await _context.Teachers
                    .Where(t => t.User.Email == teacherEmail)
                    .Select(t => t.Id)
                    .FirstOrDefaultAsync();

                var report = await _teacherService.GenerateAbsenceReport(teacherId, filter);
                if (report == null)
                {
                    return NotFound(new ErrorResponseDTO { Message = "Rapport non gÃ©nÃ©rÃ©." });
                }

                return Ok(report);
            }
            catch (Exception ex)
            {
                return StatusCode(500, new ErrorResponseDTO { Message = $"Erreur interne du serveur: {ex.Message}" });
            }
        }
    }
}

